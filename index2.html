<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>AR –ö–æ—Ñ–µ - WebXR</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    #ui {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      padding: 20px;
      text-align: center;
      z-index: 1000;
      background: rgba(0,0,0,0.7);
    }
    #startButton {
      background: #8B4513;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 25px;
      cursor: pointer;
      margin: 10px;
    }
    #status {
      margin: 10px 0;
      font-size: 16px;
    }
    #canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
    }
  </style>
</head>
<body>
  <div id="ui">
    <h1>AR –ö–æ—Ñ–µ - WebXR</h1>
    <div id="status">–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É WebXR...</div>
    <button id="startButton" disabled>üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å AR</button>
  </div>
  <canvas id="canvas"></canvas>

  <script>
    let xrSession = null;
    let xrRefSpace = null;
    let gl = null;
    let videoTexture = null;
    let video = null;
    let videoMesh = null;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É WebXR
    async function checkWebXRSupport() {
      const status = document.getElementById('status');
      const startButton = document.getElementById('startButton');
      
      if (!navigator.xr) {
        status.textContent = 'WebXR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º';
        return false;
      }

      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É AR —Å–µ—Å—Å–∏–∏
        const supported = await navigator.xr.isSessionSupported('immersive-ar');
        
        if (supported) {
          status.textContent = 'WebXR AR –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è!';
          startButton.disabled = false;
          return true;
        } else {
          status.textContent = 'AR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ';
          return false;
        }
      } catch (error) {
        status.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ WebXR: ' + error.message;
        return false;
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebXR
    async function initializeWebXR() {
      const status = document.getElementById('status');
      const canvas = document.getElementById('canvas');
      const ui = document.getElementById('ui');
      
      try {
        status.textContent = '–ó–∞–ø—É—Å–∫–∞–µ–º WebXR...';
        
        // –°–æ–∑–¥–∞–µ–º WebGL –∫–æ–Ω—Ç–µ–∫—Å—Ç
        gl = canvas.getContext('webgl', { 
          xrCompatible: true,
          alpha: true,
          antialias: false
        });
        
        if (!gl) {
          throw new Error('WebGL –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
        }

        // –°–æ–∑–¥–∞–µ–º —Å—Ü–µ–Ω—É Three.js
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.01, 100);
        
        // –°–æ–∑–¥–∞–µ–º –≤–∏–¥–µ–æ —Ç–µ–∫—Å—Ç—É—Ä—É
        video = document.createElement('video');
        video.src = 'assets/video.mp4';
        video.loop = true;
        video.muted = true;
        video.playsInline = true;
        video.preload = 'auto';
        
        videoTexture = new THREE.VideoTexture(video);
        videoTexture.minFilter = THREE.LinearFilter;
        videoTexture.magFilter = THREE.LinearFilter;
        videoTexture.format = THREE.RGBFormat;
        
        // –°–æ–∑–¥–∞–µ–º –ø–ª–æ—Å–∫–æ—Å—Ç—å –¥–ª—è –≤–∏–¥–µ–æ
        const videoGeometry = new THREE.PlaneGeometry(1.6, 0.9);
        const videoMaterial = new THREE.MeshBasicMaterial({ 
          map: videoTexture,
          transparent: true,
          side: THREE.DoubleSide
        });
        
        videoMesh = new THREE.Mesh(videoGeometry, videoMaterial);
        videoMesh.position.set(0, 0.8, 0);
        videoMesh.rotation.x = -Math.PI / 2;
        videoMesh.visible = false;
        scene.add(videoMesh);
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–Ω–¥–µ—Ä–µ—Ä–∞
        const renderer = new THREE.WebGLRenderer({
          canvas: canvas,
          context: gl,
          alpha: true,
          antialias: false
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º AR —Å–µ—Å—Å–∏—é
        const sessionInit = { 
          requiredFeatures: ['hit-test', 'dom-overlay'],
          optionalFeatures: ['image-tracking'],
          domOverlay: { root: document.body }
        };
        
        xrSession = await navigator.xr.requestSession('immersive-ar', sessionInit);
        xrSession.addEventListener('end', onSessionEnd);
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–Ω–¥–µ—Ä state
        await xrSession.updateRenderState({
          baseLayer: new XRWebGLLayer(xrSession, gl)
        });
        
        xrRefSpace = await xrSession.requestReferenceSpace('local');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º canvas –∏ —Å–∫—Ä—ã–≤–∞–µ–º UI
        canvas.style.display = 'block';
        ui.style.display = 'none';
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –≤–∏–¥–µ–æ
        video.play().catch(e => {
          console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ:', e);
        });
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–Ω–¥–µ—Ä —Ü–∏–∫–ª
        xrSession.requestAnimationFrame(onXRFrame);
        
        status.textContent = 'AR –∑–∞–ø—É—â–µ–Ω–æ! –ù–∞–π–¥–∏—Ç–µ —É–ø–∞–∫–æ–≤–∫—É –∫–æ—Ñ–µ';
        
      } catch (error) {
        status.textContent = '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ AR: ' + error.message;
        console.error('WebXR error:', error);
      }
    }

    // –†–µ–Ω–¥–µ—Ä —Ü–∏–∫–ª WebXR
    function onXRFrame(time, frame) {
      const pose = frame.getViewerPose(xrRefSpace);
      
      if (pose) {
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è image tracking
        // –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, WebXR Image Tracking –ø–æ–∫–∞ –ø–ª–æ—Ö–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ Safari
        
        // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –≤—Å–µ–≥–¥–∞ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        videoMesh.visible = true;
      }
      
      // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ü–∏–∫–ª —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
      xrSession.requestAnimationFrame(onXRFrame);
    }

    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
    function onSessionEnd() {
      const ui = document.getElementById('ui');
      const canvas = document.getElementById('canvas');
      const status = document.getElementById('status');
      const startButton = document.getElementById('startButton');
      
      ui.style.display = 'block';
      canvas.style.display = 'none';
      status.textContent = 'AR —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
      startButton.disabled = false;
      
      if (video) {
        video.pause();
      }
      
      xrSession = null;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', async () => {
      const startButton = document.getElementById('startButton');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É WebXR
      await checkWebXRSupport();
      
      startButton.addEventListener('click', initializeWebXR);
      
      // –ê–≤—Ç–æ-–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      // if (await checkWebXRSupport()) {
      //   setTimeout(initializeWebXR, 1000);
      // }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    window.addEventListener('resize', () => {
      if (gl) {
        gl.canvas.width = window.innerWidth;
        gl.canvas.height = window.innerHeight;
      }
    });
  </script>
</body>
</html>
