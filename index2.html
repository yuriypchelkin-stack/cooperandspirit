<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>AR –ö–æ—Ñ–µ - –°—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image.prod.js"></script>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-aframe.prod.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: fixed;
      background: #000;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    #instruction {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      text-align: center;
      color: white;
      background: rgba(0,0,0,0.8);
      padding: 20px;
      z-index: 1000;
      pointer-events: none;
    }
    #startButton {
      position: absolute;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      background: #8B4513;
      color: white;
      border: none;
      padding: 20px 40px;
      font-size: 20px;
      border-radius: 30px;
      cursor: pointer;
      z-index: 1001;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    #stabilityInfo {
      position: absolute;
      bottom: 120px;
      left: 0;
      width: 100%;
      text-align: center;
      color: #8B4513;
      font-size: 14px;
      z-index: 1000;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="instruction">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ AR</div>
  <div id="stabilityInfo">–î–µ—Ä–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ –¥–ª—è –ª—É—á—à–µ–π —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏</div>
  <button id="startButton">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å AR</button>

  <a-scene 
      mindar-image="imageTargetSrc: assets/targets.mind; autoStart: false;"
      id="ar-scene"
      embedded 
      renderer="colorManagement: true; antialias: true;"
      vr-mode-ui="enabled: false"
      style="display: none;">
    
    <a-assets>
      <video id="video" src="assets/video.mp4" preload="auto" loop playsinline webkit-playsinline muted></video>
    </a-assets>

    <a-camera position="0 0 0" active="false" id="camera"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      <a-entity 
          position="0 0.8 0" 
          rotation="0 0 0"
          id="target-entity">
        <a-video 
            src="#video"
            width="1.6" 
            height="0.9"
            position="0 0 0"
            autoplay="true"
            visible="false"
            id="ar-video">
        </a-video>
      </a-entity>
    </a-entity>
  </a-scene>

  <script>
    class VideoStabilizer {
      constructor() {
        this.positionBuffer = [];
        this.rotationBuffer = [];
        this.bufferSize = 10; // –†–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ –¥–ª—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
        this.stabilityThreshold = 0.01; // –ü–æ—Ä–æ–≥ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
        this.isStable = false;
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –≤ –±—É—Ñ–µ—Ä
      addPosition(position) {
        this.positionBuffer.push({
          x: position.x,
          y: position.y,
          z: position.z,
          timestamp: Date.now()
        });

        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
        if (this.positionBuffer.length > this.bufferSize) {
          this.positionBuffer.shift();
        }
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä
      addRotation(rotation) {
        this.rotationBuffer.push({
          x: rotation.x,
          y: rotation.y,
          z: rotation.z,
          timestamp: Date.now()
        });

        if (this.rotationBuffer.length > this.bufferSize) {
          this.rotationBuffer.shift();
        }
      }

      // –ü–æ–ª—É—á–∞–µ–º —Å–≥–ª–∞–∂–µ–Ω–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
      getStablePosition() {
        if (this.positionBuffer.length < 2) {
          return this.positionBuffer[0] || { x: 0, y: 0.8, z: 0 };
        }

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ (–Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–º–µ—é—Ç –±–æ–ª—å—à–∏–π –≤–µ—Å)
        let totalWeight = 0;
        let weightedSum = { x: 0, y: 0, z: 0 };

        this.positionBuffer.forEach((pos, index) => {
          const weight = (index + 1) / this.positionBuffer.length; // –í–µ—Å –æ—Ç 0.1 –¥–æ 1.0
          totalWeight += weight;
          weightedSum.x += pos.x * weight;
          weightedSum.y += pos.y * weight;
          weightedSum.z += pos.z * weight;
        });

        return {
          x: weightedSum.x / totalWeight,
          y: weightedSum.y / totalWeight,
          z: weightedSum.z / totalWeight
        };
      }

      // –ü–æ–ª—É—á–∞–µ–º —Å–≥–ª–∞–∂–µ–Ω–Ω–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ
      getStableRotation() {
        if (this.rotationBuffer.length < 2) {
          return this.rotationBuffer[0] || { x: 0, y: 0, z: 0 };
        }

        let totalWeight = 0;
        let weightedSum = { x: 0, y: 0, z: 0 };

        this.rotationBuffer.forEach((rot, index) => {
          const weight = (index + 1) / this.rotationBuffer.length;
          totalWeight += weight;
          weightedSum.x += rot.x * weight;
          weightedSum.y += rot.y * weight;
          weightedSum.z += rot.z * weight;
        });

        return {
          x: weightedSum.x / totalWeight,
          y: weightedSum.y / totalWeight,
          z: weightedSum.z / totalWeight
        };
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
      checkStability() {
        if (this.positionBuffer.length < 3) return false;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–∑–∏—Ü–∏—è—Ö
        const recent = this.positionBuffer.slice(-3);
        let positionChange = 0;

        for (let i = 1; i < recent.length; i++) {
          positionChange += Math.abs(recent[i].x - recent[i-1].x);
          positionChange += Math.abs(recent[i].y - recent[i-1].y);
          positionChange += Math.abs(recent[i].z - recent[i-1].z);
        }

        this.isStable = positionChange < this.stabilityThreshold;
        return this.isStable;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const startButton = document.getElementById('startButton');
      const scene = document.getElementById('ar-scene');
      const instruction = document.getElementById('instruction');
      const stabilityInfo = document.getElementById('stabilityInfo');
      
      const stabilizer = new VideoStabilizer();
      let isTracking = false;
      let animationFrameId = null;

      function stabilizeVideo() {
        if (!isTracking) {
          animationFrameId = requestAnimationFrame(stabilizeVideo);
          return;
        }

        const targetEntity = document.querySelector('[mindar-image-target]');
        if (targetEntity) {
          const position = targetEntity.getAttribute('position');
          const rotation = targetEntity.getAttribute('rotation');

          if (position && rotation) {
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ç–æ—Ä
            stabilizer.addPosition(position);
            stabilizer.addRotation(rotation);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
            const isStable = stabilizer.checkStability();

            // –ü–æ–ª—É—á–∞–µ–º —Å–≥–ª–∞–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const stablePosition = stabilizer.getStablePosition();
            const stableRotation = stabilizer.getStableRotation();

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ –≤–∏–¥–µ–æ
            const videoEntity = document.getElementById('target-entity');
            if (videoEntity) {
              // –ï—Å–ª–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–≥–ª–∞–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∏–Ω–∞—á–µ - –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ
              if (isStable && stabilizer.positionBuffer.length > 5) {
                videoEntity.setAttribute('position', {
                  x: stablePosition.x,
                  y: stablePosition.y + 0.8,
                  z: stablePosition.z
                });
                videoEntity.setAttribute('rotation', stableRotation);
              } else {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –Ω–æ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
                videoEntity.setAttribute('position', {
                  x: position.x,
                  y: position.y + 0.8,
                  z: position.z
                });
                videoEntity.setAttribute('rotation', rotation);
              }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
            stabilityInfo.textContent = isStable ? 
              '‚úì –°—Ç–∞–±–∏–ª—å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ' : 
              '–î–µ—Ä–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏';
            stabilityInfo.style.color = isStable ? '#4CAF50' : '#8B4513';
          }
        }

        animationFrameId = requestAnimationFrame(stabilizeVideo);
      }

      startButton.addEventListener('click', function() {
        startButton.style.display = 'none';
        instruction.textContent = '–ó–∞–ø—É—Å–∫–∞–µ–º AR...';
        stabilityInfo.style.display = 'block';

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({ 
            video: { 
              facingMode: 'environment',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            } 
          })
          .then(function(stream) {
            scene.style.display = 'block';
            instruction.textContent = '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —É–ø–∞–∫–æ–≤–∫—É –∫–æ—Ñ–µ';

            // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
            setTimeout(() => {
              const arSystem = scene.systems["mindar-image-system"];
              if (arSystem) {
                arSystem.start();
                document.getElementById('camera').setAttribute('active', 'true');
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—é
                stabilizeVideo();
              }
            }, 1000);

            const target = document.querySelector('[mindar-image-target]');
            if (target) {
              target.addEventListener('targetFound', event => {
                isTracking = true;
                instruction.textContent = '–£–ø–∞–∫–æ–≤–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞!';
                document.getElementById('ar-video').setAttribute('visible', 'true');

                const video = document.getElementById('video');
                if (video) {
                  video.play().catch(e => {
                    console.log('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ');
                  });
                }
              });

              target.addEventListener('targetLost', event => {
                isTracking = false;
                instruction.textContent = '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —É–ø–∞–∫–æ–≤–∫—É –∫–æ—Ñ–µ';
                document.getElementById('ar-video').setAttribute('visible', 'false');
                stabilityInfo.textContent = '–î–µ—Ä–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏';
                stabilityInfo.style.color = '#8B4513';
                
                // –û—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ –º–∞—Ä–∫–µ—Ä–∞
                stabilizer.positionBuffer = [];
                stabilizer.rotationBuffer = [];
              });
            }
          })
          .catch(function(error) {
            console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', error);
            instruction.textContent = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ';
            startButton.style.display = 'block';
            startButton.textContent = 'üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞';
          });
        } else {
          instruction.textContent = '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç AR';
        }
      });

      // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      window.addEventListener('beforeunload', function() {
        if (animationFrameId) {
          cancelAnimationFrame(animationFrameId);
        }
      });
    });
  </script>
</body>
</html>
