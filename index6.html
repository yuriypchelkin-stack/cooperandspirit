<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Coffee</title>

  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image.prod.js"></script>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-aframe.prod.js"></script>

  <script>
    AFRAME.registerShader('true-alpha', {
      schema: { src:{type:'map',is:'uniform'}, opacity:{type:'number',is:'uniform',default:1}},
      vertexShader:`varying vec2 vUv; void main(){vUv=uv; gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}`,
      fragmentShader:`uniform sampler2D src; uniform float opacity; varying vec2 vUv;
        void main(){ vec4 c=texture2D(src,vUv); if(c.a<0.01) discard; gl_FragColor=vec4(c.rgb, opacity*c.a); }`
    });

    AFRAME.registerComponent('force-video-update',{
      tick:function(){
        const m=this.el.getObject3D('mesh');
        if(m && m.material && m.material.map) m.material.map.needsUpdate=true;
      }
    });
  </script>

  <style>
    body { margin:0; overflow:hidden; }
    #startButton {
      position:absolute; bottom:30px; left:50%; transform:translateX(-50%);
      background:#8B4513; color:white; padding:15px 30px; border-radius:25px; font-size:18px; z-index:1001;
    }
    #instruction {
      position:absolute; top:0; left:0; width:100%; padding:15px; text-align:center;
      background:rgba(0,0,0,0.6); color:white; font-family:Arial; z-index:1000;
    }
  </style>
</head>
<body>
<div id="instruction">Наведите камеру на упаковку</div>
<button id="startButton">Запустить AR</button>

<a-scene mindar-image="imageTargetSrc: assets/targets.mind; autoStart:false;"
         renderer="alpha:true; premultipliedAlpha:false;"
         vr-mode-ui="enabled:false"
         device-orientation-permission-ui="enabled:false"
         embedded id="ar-scene">

  <a-assets>
    <video id="video-source" src="assets/video.webm" preload="auto" loop muted playsinline webkit-playsinline></video>
  </a-assets>

  <a-camera position="0 0 0" look-controls="enabled:false" active="false" id="camera"></a-camera>

  <a-entity mindar-image-target="targetIndex:0">
    <a-plane id="ar-video" width="1.6" height="0.9" position="0 0.8 0"
             visible="false"
             material="shader:true-alpha; src:#video-source; transparent:true; opacity:1.0"
             force-video-update>
    </a-plane>
  </a-entity>
</a-scene>

<script>
document.getElementById('startButton').onclick = function(){
  this.style.display='none';
  const instruction=document.getElementById('instruction');
  instruction.textContent='Ищем упаковку...';

  navigator.mediaDevices.getUserMedia({video:true}).then(()=>{
     const scene=document.getElementById('ar-scene');
     const arSystem=scene.systems['mindar-image-system'];
     arSystem.start();
     document.getElementById('camera').setAttribute('active','true');

     const target=document.querySelector('[mindar-image-target]');
     target.addEventListener('targetFound', ()=>{
       instruction.textContent='Упаковка найдена!';
       document.getElementById('ar-video').setAttribute('visible','true');
       document.getElementById('video-source').play();
     });

     target.addEventListener('targetLost', ()=>{
       instruction.textContent='Наведите камеру на упаковку';
       document.getElementById('ar-video').setAttribute('visible','false');
     });
  })
};
</script>
</body>
</html>
